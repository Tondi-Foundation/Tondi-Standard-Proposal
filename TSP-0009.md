# **TSP-0009 — CheckTemplateVerify (CTV) Covenant for Tondi**

**Template-Constrained Spending via Tapscript Covenants**
**Proposal Number:** TSP-0009
**Category:** Consensus / Covenant
**Status:** Draft
**Author:** Tondi Foundation Development Team
**Created:** 2025-09-05
**Target:** Tondi Mainnet (v2026b)
**Scope:** New covenant opcode, tapscript validation rules, transaction template hashing, interoperability with TSP-0007 (ANYPREVOUT), TSP-0008 (CISA), future TSP-0010 (Channel Factories).

This document uses RFC 2119 keywords (MUST/SHOULD/MAY).

---

## 1. **Abstract**

TSP-0009 introduces **OP\_CHECKTEMPLATEVERIFY (CTV)** as a covenant primitive for Tondi.
CTV enables outputs to commit to a fixed transaction template hash, restricting how they can be spent.
This mechanism allows scalable constructions such as:

* **Channel Factories (TSP-0010)**
* **Vaults and Recovery Flows**
* **Congestion-Controlled Batching**
* **Deterministic Multi-party Coordination**

CTV is implemented as a new tapscript opcode (`OP_CHECKTEMPLATEVERIFY_TONDI`) encoded under OP\_SUCCESSx, with a Tondi-specific transaction template hash that extends BIP-119 to include DAG consensus fields (`subnetwork_id`, `gas`).
CTV provides non-recursive covenants, ensuring safety from infinite recursion, while enabling a wide range of Layer 2 and Layer 3 protocols.

---

## 2. **Background and Motivation**

### 2.1 **What is CTV?**

CTV is a covenant mechanism that constrains how an output can be spent:

* The script includes `OP_CHECKTEMPLATEVERIFY <templateHash>`.
* When spent, the transaction must match the template (version, locktime, outputs).
* If mismatch, script fails.

This allows participants to predetermine possible exit paths without pre-signing every transaction.

### 2.2 **Bitcoin History (BIP-119)**

* Proposed by Jeremy Rubin (2019).
* Enabled batch exit transactions, congestion control, and simple vaults.
* Debate slowed activation on Bitcoin mainnet, but tested on signet.
* Key features:

  * Commits to outputs (and optionally version/locktime).
  * Non-recursive, avoiding infinite loops.
  * Enables off-chain protocols like factories and vaults.

### 2.3 **Why Tondi Needs CTV**

* **Channel Factories (TSP-0010):** require covenant-enforced exit paths.
* **Vaults:** enable safe custody with delayed recovery.
* **Congestion Control:** mass exits from Tondi Flash or DEXes.
* **Gaming / DeFi:** deterministic multi-party allocations.

Without CTV, all these require massive pre-signed transaction trees, impractical at scale.

---

## 3. **Specification**

### 3.1 **New Opcode**

```
OP_CHECKTEMPLATEVERIFY_TONDI  (OP_SUCCESSx reserved)
```

* **Consensus Rule:** Pops 32-byte template hash from stack, computes transaction template hash, compares equality. If mismatch → FAIL.
* **Non-upgraded nodes:** Treat OP\_SUCCESSx as success → soft-fork safe.

### 3.2 **Template Hash Definition**

Tondi extends BIP-119 with DAG-specific fields.
Hash function:

```
template_hash = H_tag("TSP-0009/CTVTemplate",
    le32:version ||
    le64:lock_time ||    // 64-bit instead of 32-bit
    H(sha_outputs) ||
    H(sha_prevouts) ||
    H(sha_sequences) ||
    H(subnetwork_id) ||  // Tondi-specific
    le64:gas             // Tondi-specific
)
```

Differences from Bitcoin BIP-119:

* 64-bit locktime (vs 32-bit).
* Includes `subnetwork_id` and `gas`.
* Domain separation `"TSP-0009/CTVTemplate"`.

### 3.3 **Validation Rules**

* MUST be used inside tapscript leafs (v=0xc0).
* Consumes 32-byte hash argument.
* If tx hash != pushed hash → FAIL.
* Template covers outputs, preventing mutation.

---

## 4. **Use Cases**

### 4.1 **Channel Factories (TSP-0010)**

* Funding output includes CTV → enforces exit transaction.
* Guarantees every participant can recover funds.

### 4.2 **Vaults**

* Vault output → CTV restricts spends to recovery transaction with timelocks.

### 4.3 **Congestion Control**

* Exchanges can batch withdrawals, using one on-chain tx with thousands of pre-committed outputs.

### 4.4 **Deterministic Multi-party Coordination**

* DAOs and payment pools can enforce specific allocations.

---

## 5. **Security Considerations**

* **Non-recursive:** prevents infinite loops.
* **Privacy:** CTV outputs look like normal tapscript until spent.
* **Griefing Resistance:** ensures deterministic exit paths.
* **Replay Risks:** mitigated by binding to outputs and locktime.

---

## 6. **Economic Impact**

* Reduces mempool congestion during mass exits.
* Allows batching of thousands of withdrawals.
* Saves \~90% on-chain space in factory scenarios.

---

## 7. **Interoperability**

* Works with:

  * **TSP-0007 ANYPREVOUT:** Eltoo channels inside factories.
  * **TSP-0008 CISA:** Aggregated signatures for funding tx.
  * **Future TSP-0010 Factories:** Covenant backbone.

---

## 8. **Deployment**

* **Soft Fork Path:** tapscript-only, OP\_SUCCESSx → OP\_CTV.
* **Activation:** miner signaling, DAG window 80% over \~3 months.
* **Testnet:** 6 months minimum, adversarial covenant testing.

---

## 9. **Reference Pseudocode**

```rust
fn op_checktemplateverify_tondi(tx: &Transaction, template_hash: [u8; 32]) -> Result<(), Error> {
    let computed = compute_ctv_template_hash(tx);
    if computed != template_hash {
        return Err(Error::CTVTemplateMismatch);
    }
    Ok(())
}

fn compute_ctv_template_hash(tx: &Transaction) -> [u8; 32] {
    tag_hash("TSP-0009/CTVTemplate", [
        &tx.version.to_le_bytes(),
        &tx.lock_time.to_le_bytes(),      // 64-bit
        &hash_outputs(tx.outputs),
        &hash_prevouts(tx.inputs),
        &hash_sequences(tx.inputs),
        &hash(tx.subnetwork_id),
        &tx.gas.to_le_bytes(),
    ])
}
```

---

## 10. **Test Vectors**

### Example: Single Output Vault

Input:

* tx.version = 2
* tx.lock\_time = 0
* outputs = \[ (1000 sats, P2WPKH) ]
* subnetwork\_id = 0x01
* gas = 0

Expected template hash = `0xabc123...` (vector to be computed).

---

## 11. **Roadmap**

* **TSP-0009 (CTV)** → covenant primitive.
* **TSP-0010 (Channel Factories)** → built on CTV.
* **Future Vault Spec** → optional TSP.

---

## 12. **Conclusion**

TSP-0009 introduces a minimal but powerful covenant primitive (CTV) to Tondi, enabling scalable off-chain protocols, vaults, and congestion control.
It is a prerequisite for TSP-0010 Channel Factories, and a cornerstone for the Tondi Layer 2 ecosystem.

---